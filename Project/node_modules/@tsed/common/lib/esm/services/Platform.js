import { __decorate, __metadata } from "tslib";
import { Injectable, InjectorService, ProviderScope } from "@tsed/di";
import { PlatformRouters } from "@tsed/platform-router";
import { PlatformApplication } from "./PlatformApplication.js";
import { PlatformHandler } from "./PlatformHandler.js";
/**
 * `Platform` is used to provide all routes collected by annotation `@Controller`.
 *
 * @platform
 */
let Platform = class Platform {
    injector;
    platformApplication;
    platformRouters;
    #layers;
    constructor(injector, platformApplication, platformRouters) {
        this.injector = injector;
        this.platformApplication = platformApplication;
        this.platformRouters = platformRouters;
        platformRouters.prebuild();
    }
    get app() {
        return this.platformApplication;
    }
    addRoutes(routes) {
        routes.forEach((routeSettings) => {
            this.addRoute(routeSettings.route, routeSettings.token);
        });
    }
    addRoute(route, token) {
        const provider = this.injector.getProvider(token);
        if (!provider || provider.hasParent()) {
            return this;
        }
        const router = this.platformRouters.from(provider.token);
        this.app.use(route, router);
        return this;
    }
    getLayers() {
        this.#layers = this.#layers || this.platformRouters.getLayers(this.app);
        return this.#layers;
    }
    /**
     * Get all controllers mounted on the application.
     * @returns  {RouteController[]}
     */
    getMountedControllers() {
        const controllers = this.getLayers().reduce((controllers, layer) => {
            if (layer.isProvider()) {
                const route = String(layer.getBasePath());
                const key = `${layer.provider.toString()}:${route}`;
                if (!controllers.has(key)) {
                    controllers.set(key, {
                        route,
                        routes: new Set(),
                        provider: layer.provider
                    });
                }
                controllers.get(key).routes.add(String(layer.path));
            }
            return controllers;
        }, new Map());
        return [...controllers.values()];
    }
};
Platform = __decorate([
    Injectable({
        scope: ProviderScope.SINGLETON,
        imports: [PlatformHandler]
    }),
    __metadata("design:paramtypes", [InjectorService,
        PlatformApplication,
        PlatformRouters])
], Platform);
export { Platform };
//# sourceMappingURL=Platform.js.map