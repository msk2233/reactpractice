"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PlatformExceptions = void 0;
const tslib_1 = require("tslib");
const core_1 = require("@tsed/core");
const di_1 = require("@tsed/di");
const ErrorFilter_1 = require("../components/ErrorFilter");
const ExceptionFilter_1 = require("../components/ExceptionFilter");
const MongooseErrorFilter_1 = require("../components/MongooseErrorFilter");
const StringErrorFilter_1 = require("../components/StringErrorFilter");
const ExceptionFiltersContainer_1 = require("../domain/ExceptionFiltersContainer");
const ResourceNotFound_1 = require("../errors/ResourceNotFound");
/**
 * Catch all errors and return the json error with the right status code when it's possible.
 *
 * @platform
 */
let PlatformExceptions = class PlatformExceptions {
    types = new Map();
    injector;
    $onInit() {
        ExceptionFiltersContainer_1.ExceptionFiltersContainer.forEach((token, type) => {
            this.types.set(type, this.injector.get(token));
        });
    }
    catch(error, ctx) {
        const name = (0, core_1.nameOf)((0, core_1.classOf)(error));
        if (name && this.types.has(name)) {
            return this.types.get(name).catch(error, ctx);
        }
        const target = (0, core_1.ancestorsOf)(error)
            .reverse()
            .find((target) => this.types.has(target));
        if (target) {
            return this.types.get(target).catch(error, ctx);
        }
        // default
        return this.types.get(Error).catch(error, ctx);
    }
    resourceNotFound(ctx) {
        return this.catch(new ResourceNotFound_1.ResourceNotFound(ctx.request.url), ctx);
    }
};
tslib_1.__decorate([
    (0, di_1.Inject)(),
    tslib_1.__metadata("design:type", di_1.InjectorService)
], PlatformExceptions.prototype, "injector", void 0);
PlatformExceptions = tslib_1.__decorate([
    (0, di_1.Injectable)({
        imports: [ErrorFilter_1.ErrorFilter, ExceptionFilter_1.ExceptionFilter, MongooseErrorFilter_1.MongooseErrorFilter, StringErrorFilter_1.StringErrorFilter]
    })
], PlatformExceptions);
exports.PlatformExceptions = PlatformExceptions;
//# sourceMappingURL=PlatformExceptions.js.map